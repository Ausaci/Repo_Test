# File: .github/workflows/sync-souce-owner-repo-template.yml
# Need add secrets.PAT

# 1. Need Change Here!
name: repo-sync-by-script
on:
  workflow_dispatch:
 # schedule:
   # - cron: '0 1 * * 1'
    # UTC时区，比我们东八区早，上面示例为：每周一9点。
    
env:
  TZ: Asia/Shanghai
  TOCURRENT: false
  TOREMOTE: true
  SYNCTAGS: false
  LISTARRAY: false
  # 2. Need Change Here!
  # SOURCE_OWNER: ChangeMe
  # DEST_OWNER: Namestars
  
jobs:
  sync-remote-repo:
    runs-on: ubuntu-latest
    if: github.event.sender.id == '54447830' || github.event.repository.owner.id == github.event.sender.id
        
    steps:  
      - uses: actions/checkout@v3
        with:
          persist-credentials: false
          
      - name: git-sync-remote
        env:
          SYNC_SOURCE_TOKEN: ${{ secrets.SYNC_SOURCE_TOKEN }}
          SYNC_DEST_OWNER: ${{ secrets.SYNC_DEST_OWNER }}
          SYNC_DEST_OWNER_EMAIL: ${{ secrets.SYNC_DEST_OWNER_EMAIL }}
          SYNC_DEST_TOKEN: ${{ secrets.SYNC_DEST_TOKEN }}
          DEST_SSH_KEY: ${{ secrets.SYNC_DEST_SSH_PRIVATE_KEY }}
        run: |
          sudo apt-get update
          sudo apt-get install dos2unix
          cd $GITHUB_WORKSPACE/sync-repo/git-sync
          chmod 755 *.sh *.yml
          docker build -t git-sync:dev_tag -q .
          echo "docker build successfuly"
          cd $GITHUB_WORKSPACE/sync-repo
          pwd
          ls
          dos2unix *.sh *.CSV
          chmod 755 *.sh
          sudo ./sync-repo-action.sh ${SYNC_DEST_OWNER} ${SYNC_DEST_OWNER_EMAIL} ${SYNC_DEST_TOKEN} ${DEST_SSH_KEY} ${SYNC_SOURCE_TOKEN}
          # ${{ env.SYNC_DEST_OWNER }} ${{ env.SYNC_DEST_OWNER_EMAIL }} ${{ env.SYNC_DEST_TOKEN }} ${{ env.DEST_SSH_KEY }} ${{ env.SYNC_SOURCE_TOKEN }}
          # cat ${REPO_MATRIX_FILE}
          # rm -rf ${FUN_LOG} ${REPO_MATRIX_FILE} ${JSONDIR} ${WIKIDIR}

      # - name: Telegram notification
        # uses: appleboy/telegram-action@master
        # with:
          # to: ${{ secrets.TELEGRAM_CHAT_ID }}
          # token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          # message: |
            # 同步时间：${{ env.DATE }}
            # 已使用 Github 更新完成
        
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2.0.1
        with:          
          token: ${{ secrets.PAT }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 1
          
